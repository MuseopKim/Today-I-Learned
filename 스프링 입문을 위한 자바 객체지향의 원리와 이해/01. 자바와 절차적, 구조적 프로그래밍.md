## JVM

- JDK (자바 개발 도구 - 소프트웨어 개발 도구) : JVM용 소프트웨어 개발 도구
- JRE (자바 실행 환경 - 운영체제) : JVM용 OS
- JVM (자바 가상 기계 - 하드웨어) : 가상의 컴퓨터
- JDK가 JRE를 포함, JRE는 JVM을 포함

## JVM의 메모리 사용 방식

모든 프로그램은 코드 실행 영역 / 데이터 저장영역으로 나뉘게 된다. 그리고 객체지향 프로그램에서는 데이터 저장 영역을 다시 세 개의 영역으로 분할한다.

- 데이터 저장 영역
  - Static - Class
  - Stack - Method
  - Heap - Object

### main() : 메서드 스택 프레임

main 메서드는 프로그램이 시작 되는 영역이다. 프로그램 시작 이후의 흐름은 다음과 같다.

1. JRE는 우선 프로그램에 main() 메서드가 있는지 확인한다.
2. main 메서드가 확인 되면 JRE는 JVM을 부팅한다. 부팅된 JVM은 목적 파일을 받아 그 목적 파일을 실행한다.
3. 이제 JVM은 전처리 과정을 시작하는데, java.lang 패키지를 스태틱 영역에 가져다 둔다.
4. 이후 개발자가 작성한 모든 클래스, 임포트 패키지들을 스태틱 영역에 가져다 놓는다.
5. 이제 main 메서드를 실행하기 위해 스택 프레임이 스택 영역에 할당된다.
   (메서드 시작 중괄호를 하나 만날 때마다 스택 프레임이 하나씩 생기고, 끝 중괄호를 만나면 스택 프레임이 소멸된다.)
6. 메서드 인자들의 변수 공간을 할당한다. (main() 의 경우 args의 공간 할당)
7. main() 메서드를 실행한다.
8. main() 메서드의 끝 중괄호를 만나면 프로그램이 올라가 있던 메모리가 소멸하고, JVM 중지, JRE가 사용했던 자원을 운영체제에 반납한다.

### 블록 구문과 메모리 : 블록 스택 프레임

if 같은 블록의 시작 중괄호를 만나면 블록 스택 프레임이 메서드 스택 프레임 안에 중첩되어 생긴다. 또한 해당 중괄호가 사라지면 중첩되어 있던 블록 스택 프레임도 사라진다.

### 지역 변수와 메모리

스태틱, 스택, 힙 영역 모두 변수가 할당 되는데, 변수의 종류에 따라 할당되는 영역이 다르다.

**지역 변수**는 스택에 할당 된다. 스택 프레임이 생성될 때 올라갔다가, 스택 프레임이 사라지면 함께 소멸한다.

**클래스 멤버 변수**는 스태틱 영역에 할당 된다. 한번 할당 된 클래스 멤버 변수는 JVM이 종료될 때까지 그대로 존재하게 된다.

객체 멤버 변수는 힙에 할당 되는데, 객체와 함께 가비지 컬렉터에 의해 힙 메모리에서 회수된다.

### 메서드 호출과 메모리 : 메서드 스택 프레임 2

메서드가 호출 되면 해당 메서드의 스택 프레임이 새로 생성되고, (반환 값이 있는 경우) 반환 값, 파라미터, 지역변수 순서로 스택 프레임 내부에 할당 된다.

**Call By Value**

메서드를 호출하면서 인자로 전달하는 값이 변수 자체가 아닌, 변수가 저장한 값만을 복사하여 전달하는 것

### 전역 변수와 메모리

전역 변수는 코드 어느곳에서나 접근할 수 있으며 여러 메서드들에 의해 공유 된다. 이러한 전역 변수는 여러 사이드 이펙트를 낳을 수 있고, 되도록 사용하지 않는 것이 좋다. 특히 멀티 스레드 프로그램이라면 더욱 위험하다.
전역 변수는 오직 읽기 전용 값으로만 사용하자.

### 멀티 스레드 / 멀티 프로세스

멀티 스레드 프로세스는 각 프로세스마다 각자의 T메모리를 갖는데, 이는 서로 참조할 수 없다.

반면 멀티 스레드의 T메모리 모델은 스택 영역을 스레드 개수만큼 분할해서 쓰는 것이다. 멀티 스레드는 하나의 T메모리만을 사용하며 스택 영역만 분할해서 사용한다.
멀티 스레드 환경에서 한 스레드는 다른 스레드의 스택 영역은 침범할 수 없지만 스태틱 영역과 힙 영역은 공유해서 사용한다.

멀티 프로세스 대비 메모리를 적게 사용하기 때문에 서블릿은 효율적으로 요청당 스레드를 생성한다.
