# 실행계획 개요

## 쿼리 실행 순서

MySQL 서버에서 쿼리가 실행되는 과정은 3가지로 나눌 수 있다.

1. 사용자로부터 요청된 SQL 문장을 잘게 쪼개서 MySQL 서버가 이해할 수 있는 수준으로 분리한다.
   - `SQL 파서`가 작업을 수행, 이 과정에서 문법적으로 잘못 됐다면 해당 SQL은 걸러진다. 또한 이 과정에서 파스트리가 만들어진다.
2. SQL의 파싱 정보를 확인하면서 어떤 테이블로부터 읽고 어떤 인덱스를 이용해 테이블을 읽을지 선택한다. 이 과정에서 파스 트리를 참조하면서 다음과 같은 내용을 처리한다.

   1. 불필요한 조건의 제거 및 복잡한 연산의 단순화
   2. 여러 테이블의 조인이 있는 경우 어떤 순서로 테이블을 읽을지 결정
   3. 각 테이블에 사용된 조건과 인덱스 통계 정보를 이용해 사용할 인덱스 결정
   4. 가져온 레코드들을 임시 테이블에 넣고 다시 한번 가공해야 하는지 결정

   위 작업은 `옵티마이저` 가 처리한다. 이 과정이 끝나면 `쿼리실행 계획`이 만들어진다.

3. 두 번째 단계에서 결정된 테이블의 읽기 순서나 선택 된 인덱스를 이용해 스토리지 엔진으로부터 데이터를 가져온다. MySQL 엔진에서는 스토리지 엔진으로부터 받은 레코드를 조인하거나 정렬하는 작업ㅇ르 수행한다. 이 과정은 MySQL 엔진과 스토리지 엔진이 동시에 참여해 처리한다.

---

## 옵티마이저 종류

옵티마이저는 데이터베이스 서버에서 두뇌와 같은 역할을 담당하고 있다. 옵티마이저는 `비용 기반 최적화 방법`과 `규칙 기반 최적화 방법` 으로 나눌 수 있다.

### 규칙 기반 최적화

기본적으로 대상 테이블의 레코드 건수나 선택도 등을 고려하지 않고 옵티마이저에 내장된 우선순위에 따라 실행 계획을 수립하는 방식. 이 방식에서는 통계 정보 (테이블의 레코드 건수, 컬럼 값의 분포도)를 조사하지 않고 실행 계획이 수립되기 때문에 거의 항상 같은 실행 방법을 만들어낸다.

### 비용 기반 최적화

쿼리를 처리하기 위한 여러 가지 가능한 방법을 만들고 각 단위 작업의 비용 정보와 대상 테이블의 예측된 통계 정보를 이용해 각 실행 계획별 비용을 산출한다. 이렇게 산출된 각 방법별로 최소 비용 기반의 옵티마이저를 채택한다.

---

## 통계 정보

비용 기반 최적화에서 가장 중요한 것은 통계 정보다. 통계 정보가 정확하지 않다면 효율적인 쿼리 실행 계획을 세울 수 없게 된다.

MySQL 또한 비용 기반 최적화를 사용하지만 다른 DBMS에 비해 통계 정보는 다양한 편이 아니다. MySQL에 의해 관리되는 통계 정보는 레코드 건수, 인덱스의 유니크한 개수 정도다. MySQL에서 통계 정보는 사용자가 알아채지 못하는 순간 자동으로 변경되며 동적으로 업데이트 된다. 이와 다른 방법으로는 `ANALYZE` 명령을 사용하면 강제적으로 통계 정보가 갱신되기도 한다.

```sql
SHOW TABLE STATUS LIKE 'tb_test'\G
SHOW INDEX FROM tb_test;
```

ANALYZE를 실행하는 동안 MyISAM 테이블은 읽기는 가능하지만 쓰기는 불가능하다. 그러나 InnoDB는 읽기, 쓰기가 모두 불가능하므로 서비스 도중에는 사용하지 않는 것이 좋다.
