------



## 캐시 처리 단계

   웹 캐시의 기본 동작은 대개 단순하다. 이는 다음과 같은 7단계를 거치게 된다.

1. 요청 받기 : 네트워크로부터 도착한 요청 메시지를 읽는다.
2. 파싱 : 메시지를 파싱하여 URL과 헤더들을 추출한다.
3. 검색 : 로컬 복사본이 있는지 검사하고, 사본이 없다면 사본을 받아와 로컬에 저장한다.
4. 신선도 검사 : 캐시된 사본이 신선한지 검사하고, 신선하지 않다면 변경 사항이 있는지 서버에게 물어본다.
5. 응답 생성 : 새로운 헤더와 캐시된 본문으로 응답 메시지를 생성한다.
6. 발송 : 네트워크를 통해 응답을 클라이언트에게 돌려준다.
7. 로깅 : 캐시는 로그파일에 트랜잭션에 대해 서술한 로그 하나를 남긴다.



------



## 캐시 사본 유지하기

   캐시된 사본 모두가 원 서버의 문서를 모두 충실히 반영하진 못한다. 캐시가 주기적으로 갱신되지 못하면 오래된 데이터를 보관하게 되고, 이는 캐시로서의 역할을 하지 못하게 된다. 따라서 캐시된 데이터는 서버의 데이터와 일치하도록 관리 되어야 한다.



### 문서 만료

HTTP는 Cache-Control, Expires 라는 헤더들을 이용하여 원 서버가 각 문서에 유효기간을 붙일 수 있게 해준다.이 기간이 만료되면 캐시는 반드시 서버와 문서에 변경된 것이 있는지 검사해야 한다.



### 서버 재검사

캐시된 문서가 만료되면, 그 문서가 원 서버의 문서와 일치하는지를 서버에 묻는다. 이 검사를 '서버 재검사'라 한다. 재검사 결과 콘텐츠가 변경 되었다면, 문서의 새로운 사본을 가져와 데이터를 갱신한 뒤 클라이언트에게 보낸다. 만약 콘텐츠가 변경되지 않았다면 새 만료일을 포함한 새 헤더들만 가져와서 캐시 안의 헤더들을 갱신한다.



------



## 캐시 제어

HTTP는 문서가 만료되기 전까지 얼마나 오랫동안 캐시될 수 있게 할 것인지 서버가 설정할 수 있는 여러 옵션을 정의한다.

- no-store
- no-cache
- mulst-revalidate
- max-age
- Expires
- 아무 정보도 주지 않고 캐시가 스스로 최대 나이를 계산



### **no-store**

캐시가 그 응답의 사본을 만드는 것을 금지한다.  클라이언트에게 전달한 뒤 객체를 삭제한다.



### **no-cache**

서버와 재검사를 꼭 거치고 클라이언트에게 제공하게 한다.



### Max-Age

```
문서가 서버로부터 온 이후로 흐른 시간으로, 초로 나타낸다. 
```



### Expires

실제 만료 날짜를 나타낸다.



### Must-Revalidate

캐시가 만료 정보를 엄격히 따르길 원할 때 표기한다. 재검사를 시도했을 때 원 서버가 사용할 수 없는 상태라면 캐시는 반드시 504 Gateway Timeout error를 반환해야 한다.



### 휴리스틱 만료

만약 위에 언급한 응답 헤더들에 포함되지 않는다면 캐시는 경험적인 방법으로 최대 나이를 계산해야 한다. 보통 LM인자 알고리즘으로 계산하여 최대 나이 값이 24시간보다 크다면 Heuristic Expiration 경고 헤더가 응답 헤더에 추가 되어야 한다. 보통 휴리스틱 신선도 유지기간은 1주일로 상한을 설정한다.



### 클라이언트 신선도 제약

클라이언트는 웹브라우저의 리프레시나 리로드 버튼을 통해 캐시의 신선도를 컨트롤 할 수 있다. 신선도를 엄격하게 할 수도 있고, 느슨하게 할 수도 있다.