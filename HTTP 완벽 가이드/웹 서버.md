## 웹 서버

"웹서버" 라는 용어는 웹 서버 소프트웨어와 하드웨어 양쪽 모두를 지칭한다. 따라서 기능과 형태가 매우 다양하다. 그 모습은 다양하지만, 웹 서버의 본질은 리소스에 대한 HTTP 요청을 받아서 처리하여 응답을 제공하는데에 있다.



## 웹 서버 구현

웹 서버는 HTTP와 TCP 처리를 구현한 것으로 HTTP 프로토콜을 구현하고, 웹 리소스를 관리하고, 웹 서버 관리 기능을 제공 한다. 웹 서버는 TCP 커넥션 관리에 대한 책임을 운영체제와 나눠 갖는다. 웹 서버는 여러가지 형태로 구현 된다.

- 소프트웨어 형태의 웹 서버를 컴퓨터에 설치하고 실행 한다.
- 몇 개의 컴퓨터 칩으로 구현된 웹 서버를 내장 시켜서 관리 콘솔로 제공 된다.



### 다목적 소프트웨어 웹 서버

컴퓨터 시스템에 설치 되어 동작한다. 아파치, W3C의 직소 같은 오픈 소스 소프트웨어, 상용소프트웨어 등이 있다.



### 임베디드 웹 서버

일반 소비자용 제품에 내장될 목적으로 만들어진 작은 웹 서버이다.



---



## 웹 서버의 작동

웹 서버는 다음의 과정을 통해 요청을 처리한다.

1. 클라이언트의 접속을 받아들여 커넥션을 맺는다. 원치 않을 경우 접속을 거절할 수 있다.
2. HTTP 요청 메시지를 네트워크로부터 읽어 들인다.
3. 요청 메시지를 해석하고 처리 할 준비를 한다.
4. 메시지에서 지정한 리소스에 접근한다.
5. 헤더를 포함한 HTTP 응답 메시지를 생성한다.
6. 응답을 클라이언트에게 돌려준다.
7. 로그파일에 트랜잭션 완료에 대한 로그를 남긴다.



### 1단계 : 커넥션 수락

클라이언트가 서버에 대해 열려있는 지속적 커넥션을 가지고 있다면 해당 커넥션을 사용하고, 아라면 서버에 대한 새 커넥션을 열어야 한다.

클라이언트가 웹 서버에 TCP 커넥션을 요청하면 웹 서버는 그 커넥션을 맺고 TCP 커넥션에서 IP 주소를 추출하여 커넥션 맞은편에 어떤 클라이언트가 있는지 확인 한다. 새 커넥션이 맺어지면 서버는 커넥션을 커넥션 목록에 추가한다. 이 때 서버는 클라이언트에 따라 커넥션을 거부할 수도 있다. 서버는 '역방향 DNS' 를 사용해서 클라이언트의 IP 주소를 클라이언트의 호스트 명으로 변환하여 접근 제어와 로깅에 사용할 수 있다.



### 2단계 : 요청 메시지 수신

커넥션에 데이터가 도착하면 웹 서버는 데이터를 읽어 들이고 파싱하여 요청 메시지를 구성한다. 요청 메시지를 파싱하는 과정은 다음과 같다.

1. 요청 줄을 파싱하여 요청 메서드, 리소스 식별자(URI), 버전 번호를 찾는다.

2. 메시지 헤더들을 읽는다.

3. 헤더의 끝을 의미하는 CRLF로 끝나는 빈 줄을 찾는다.

4. 요청 본문이 있다면 읽어 들인다.

   웹 서버는 요청 메시지를 쉽게 다룰 수 있도록 요청 메시지를 내부 표현 형태로 파싱하여 저장하기도 한다.



**스레드와 웹서버**

프로세스란 어떤 프로그램의 하나의 독립된 제어 흐름이다. 스레드는 프로세스의 더 빠르고 효율적인 버전을 말한다. 둘 사이에는 엄연한 성능상의 차이가 존재한다.

- 단일 스레드 웹 서버 : 한 번에 하나씩 요청을 처리한다. 구현하기 간단하지만 처리 도중에 다른 커넥션은 무시 된다.
- 멀티프로세스와 멀티스레드 웹 서버 : 여러 요청을 동시에 처리하기 위해 여러 개의 프로세스 혹은 스레드를 할당한다.
- 다중 멀티스레드 웹서버 : CPU 여러개의 이점을 살리기 위해 멀티스레딩과 다중화를 결합한다. 여러 개의 스레드는 각각 열려있는 커넥션을 감시하고 각 커넥션에 대해 조금씩 작업을 수행한다.



### 3단계 : 요청 처리

웹 서버가 요청 메서드, 리소스, 헤더, 본문에 대한 파싱을 마치면 이를 바탕으로 처리를 시작한다. POST를 비롯한 몇몇 메서드는 요청 메시지에 엔터티 본문이 있을 것을 요구한다.



### 4단계 : 리소스의 매핑과 접근

클라이언트의 요청 메시지의 URI에 해당하는 리소스를 웹 서버에서 찾아내고 식별한다.



**Docroot**

요청 URI를 웹 서버의 파일 시스템 안에 있는 파일 이름으로 사용하는 것을 말한다. 웹 서버 파일 시스템의 특별한 폴더를 웹 콘텐츠를 위해 예약 해 두는데, 이를 문서 루트 혹은 docroot라 부른다. ex) 요청 URI : /specials/saw-blade.gif   ⇒  서버 리소스 : /usr/local/httpd/files/specials/saw-blade.gif



**디렉터리 목록**

클라이언트가 파일이 아닌 디렉터리를 가리키는 디렉터리 URI에 대한 요청을 할 경우, 다음과 같은 행동을 취하도록 설정할 수 있다.

- 에러 반환
- '색인 파일' 반환
- 디렉터리를 탐색해서 그 내용을 담은 HTML 페이지 반환



**동적 콘텐츠 리소스 매핑**

웹 서버는 요청에 맞게 콘텐츠를 생성하는 프로그램에 URI를 매핑할 수 있다.



**접근 제어**

웹 서버는 각각의 리소스에 접근 제어를 할당할 수 있다. 접근 제어되는 리소스에 대한 요청이 도착했을 때 웹 서버는 클라이언트의 IP 주소에 근거하여 접근을 제어하거나 비밀번호를 물을 수 있다.



### 5단계 : 응답 만들기

서버가 리소스를 식별하면 요청 메서드의 동작을 수행한 뒤 응답 메시지를 반환한다. 응답 메시지는 응답 상태 코드, 응답 헤더, 응답 본문을 포함한다.



**응답 엔터티**

응답 본문이 생성 된다면 응답 메시지와 함께 전달한다. 응답 메시지에 포함 되는 내용은 다음과 같다.

- 응답 본문의 MIME 타입을 서술하는 Content-Type 헤더
- 응답 본문의 길이를 서술하는 Content-Length 헤더
- 응답 본문의 내용



**MIME 타입의 결정**

웹 서버는 응답 본문의 MIME 타입을 결정해야 할 의무가 있다.

- mime. types : MIME 타입을 나타내기 위해 파일과 확장자를 사용하여 표현한다.
- Magic typing : 파일의 내용을 검사하여 패턴에 대한 테이블에 해당하는 패턴이 있는지 찾아 타입을 결정한다.
- 유형 명시(Explicit typing) : 특정 디렉터리 안의 파일들이 확장자나 내용에 관계 없이 특정 MIME 타입을 갖도록 웹 서버를 설정할 수 있다.
- 유형 협상(Type negotiation) : 리소스가 여러 종류의 문서 형식에 속하도록 설정 하는 것, 서버가 사용자와의 협상 과정을 통해 사용하기 가장 좋은 형식을 결정 할 수 있다.



**리다이렉션**

웹 서버는 요청을 수행하기 위해 브라우저가 다른 곳으로 가도록 리다이렉트 할 수 있다. 리다이렉트는 다음과 같은 경우 유용하다.

- 영구히 리소스가 옮겨진 경우 : 리소스는 새로운 URL이 부여되어 새로운 위치로 옮겨졌거나 이름이 바뀌었을 수 있다. 301(Moved Permanently) 상태 코드는 이런 종류의 리다이렉트를 위해 사용된다.
- 임시로 리소스가 옮겨진 경우 : 이름 변경이 임시적이기 때문에 클라이언트가 나중에는 원래 URL로 찾아오고 갱신하지 않기를 원한다. 303(See Other), 307(Temporary Redirect) 상태 코드를 사용한다.
- URL 증강 : 문맥 정보를 포함시키기 위해 재 작성된 URL로 리다이렉트 한다. 303(See Other), 307(Temporary Redirect) 상태 코드를 사용한다.
- 부하 균형 : 과부화된 서버가 요청을 받으면 서버는 클라이언트를 좀 덜 부하가 걸린 서버로 리다이렉트 할 수 있다. 303(See Other), 307(Temporary Redirect) 상태 코드를 사용한다.
- 친밀한 다른 서버 : 서버는 클라이언트를 그 클라이언트에 대한 정보를 갖고 있는 다른 서버로 리다이렉트 할 수 있다. 303(See Other), 307(Temporary Redirect) 상태 코드를 사용한다.
- 디렉터리 이름 정규화 : 클라이언트가 디렉터리 이름에 대한 URI를 요청하는 과정에서 '/'를 빠뜨렸다면 상대경로가 정상 동작할 수 있도록 '/'를 추가한 URI로 리다이렉트 한다.



### 응답 보내기

웹 서버는 만들어진 응답을 커넥션 너머 클라이언트에게 전달한다. 서버는 여러 클라이언트에 대한 많은 커넥션을 가질 수 있으며, 해당 커넥션들의 일부는 서버로 데이터로 보내고 있거나 클라이언트로 돌려줄 응답 데이터를 전송하고 있다. 지속적인 커넥션이라면 아무것도 동작하지 않은 채 연결만 되어 있기도 한다. 비지속적인 커넥션의 경우 모든 응답을 보낸 뒤 자신쪽의 커넥션을 닫는다.



### 7단계 : 로깅

트랜잭션이 모두 완료 되면 웹 서버는 트랜잭션이 어떻게 수행 되었는지에 대한 로그를 로그 파일에 기록한다.